<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>جنگ جهانی سوم - بازی استراتژیک</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * {
            font-family: 'Vazirmatn', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 25%, #334155 50%, #475569 75%, #64748b 100%);
            min-height: 100vh;
            position: relative;
            overflow-x: hidden;
        }
        
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grid" width="10" height="10" patternUnits="userSpaceOnUse"><path d="M 10 0 L 0 0 0 10" fill="none" stroke="rgba(255,255,255,0.03)" stroke-width="0.5"/></pattern></defs><rect width="100" height="100" fill="url(%23grid)"/></svg>');
            z-index: -1;
        }
        
        .glass-card {
            background: rgba(15, 23, 42, 0.7);
            border: 1px solid rgba(148, 163, 184, 0.2);
            border-radius: 16px;
            backdrop-filter: blur(20px);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }
        
        .war-btn {
            background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);
            color: white;
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            box-shadow: 0 4px 15px rgba(220, 38, 38, 0.3);
            position: relative;
            overflow: hidden;
        }
        
        .war-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }
        
        .war-btn:hover::before {
            left: 100%;
        }
        
        .war-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(220, 38, 38, 0.4);
        }
        
        .peace-btn {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            color: white;
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            box-shadow: 0 4px 15px rgba(5, 150, 105, 0.3);
        }
        
        .peace-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(5, 150, 105, 0.4);
        }
        
        .neutral-btn {
            background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
            color: white;
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
        }
        
        .neutral-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(99, 102, 241, 0.4);
        }
        
        .admin-btn {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            box-shadow: 0 4px 15px rgba(245, 158, 11, 0.3);
        }
        
        .admin-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(245, 158, 11, 0.4);
        }
        
        .war-input {
            background: rgba(15, 23, 42, 0.8);
            border: 2px solid rgba(148, 163, 184, 0.3);
            border-radius: 12px;
            padding: 16px;
            color: white;
            width: 100%;
            font-size: 16px;
            transition: all 0.3s ease;
        }
        
        .war-input:focus {
            outline: none;
            border-color: #dc2626;
            box-shadow: 0 0 0 4px rgba(220, 38, 38, 0.1);
        }
        
        .war-input::placeholder {
            color: rgba(148, 163, 184, 0.6);
        }
        
        .sidebar {
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(20px);
            border-left: 1px solid rgba(148, 163, 184, 0.2);
            box-shadow: 5px 0 25px rgba(0, 0, 0, 0.3);
        }
        
        .sidebar-item {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px 20px;
            color: rgba(148, 163, 184, 0.8);
            margin: 4px 12px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }
        
        .sidebar-item:hover {
            background: rgba(220, 38, 38, 0.1);
            color: #fca5a5;
            transform: translateX(-4px);
        }
        
        .sidebar-item.active {
            background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(220, 38, 38, 0.3);
        }
        
        .sidebar-item.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: rgba(100, 116, 139, 0.3);
            color: rgba(148, 163, 184, 0.5);
        }
        
        .sidebar-item.disabled:hover {
            background: rgba(100, 116, 139, 0.3);
            color: rgba(148, 163, 184, 0.5);
            transform: none;
        }
        
        .navbar {
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(148, 163, 184, 0.2);
            box-shadow: 0 4px 25px rgba(0, 0, 0, 0.3);
        }
        
        .stat-card {
            background: linear-gradient(135deg, rgba(15, 23, 42, 0.8) 0%, rgba(30, 41, 59, 0.8) 100%);
            border: 1px solid rgba(148, 163, 184, 0.2);
            border-radius: 16px;
            padding: 24px;
            text-align: center;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 2px;
            background: linear-gradient(90deg, #dc2626, #f59e0b, #059669, #3b82f6);
        }
        
        .stat-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
        }
        
        .weapon-card {
            background: linear-gradient(135deg, rgba(15, 23, 42, 0.9) 0%, rgba(30, 41, 59, 0.9) 100%);
            border: 1px solid rgba(148, 163, 184, 0.2);
            border-radius: 20px;
            padding: 28px;
            transition: all 0.4s ease;
            position: relative;
            overflow: hidden;
        }
        
        .weapon-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(220, 38, 38, 0.05) 0%, rgba(245, 158, 11, 0.05) 100%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .weapon-card:hover::before {
            opacity: 1;
        }
        
        .weapon-card:hover {
            transform: translateY(-12px) scale(1.02);
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
            border-color: rgba(220, 38, 38, 0.4);
        }
        
        .news-card {
            background: linear-gradient(135deg, rgba(15, 23, 42, 0.8) 0%, rgba(30, 41, 59, 0.8) 100%);
            border: 1px solid rgba(148, 163, 184, 0.2);
            border-radius: 16px;
            border-right: 4px solid #dc2626;
            transition: all 0.3s ease;
        }
        
        .news-card:hover {
            transform: translateX(-8px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.4);
        }
        
        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(220, 38, 38, 0.3);
            border-top: 4px solid #dc2626;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .war-title {
            background: linear-gradient(135deg, #dc2626 0%, #f59e0b 50%, #dc2626 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: titleGlow 3s ease-in-out infinite alternate;
        }
        
        @keyframes titleGlow {
            0% { filter: drop-shadow(0 0 10px rgba(220, 38, 38, 0.5)); }
            100% { filter: drop-shadow(0 0 20px rgba(245, 158, 11, 0.8)); }
        }
        
        .mobile-menu {
            position: fixed;
            top: 80px;
            right: -100%;
            width: 280px;
            height: calc(100vh - 80px);
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(20px);
            z-index: 50;
            transition: right 0.4s ease;
            border-left: 1px solid rgba(148, 163, 184, 0.2);
        }
        
        .mobile-menu.open {
            right: 0;
        }
        
        .hamburger {
            display: flex;
            flex-direction: column;
            gap: 4px;
            padding: 8px;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        
        .hamburger:hover {
            background: rgba(220, 38, 38, 0.1);
        }
        
        .hamburger span {
            width: 28px;
            height: 3px;
            background: white;
            transition: all 0.3s ease;
            border-radius: 2px;
        }
        
        .hamburger.active span:nth-child(1) {
            transform: rotate(45deg) translate(6px, 6px);
        }
        
        .hamburger.active span:nth-child(2) {
            opacity: 0;
        }
        
        .hamburger.active span:nth-child(3) {
            transform: rotate(-45deg) translate(6px, -6px);
        }
        
        @media (max-width: 768px) {
            .sidebar {
                display: none;
            }
            
            .main-content {
                margin-right: 0 !important;
            }
        }
        
        .trade-card {
            background: linear-gradient(135deg, rgba(5, 150, 105, 0.1) 0%, rgba(16, 185, 129, 0.1) 100%);
            border: 1px solid rgba(5, 150, 105, 0.3);
            border-radius: 16px;
            padding: 24px;
        }
        
        .attack-card {
            background: linear-gradient(135deg, rgba(220, 38, 38, 0.1) 0%, rgba(153, 27, 27, 0.1) 100%);
            border: 1px solid rgba(220, 38, 38, 0.3);
            border-radius: 16px;
            padding: 24px;
        }
    </style>
</head>
<body>
    <!-- صفحه بارگذاری -->
    <div id="loadingPage" class="min-h-screen flex items-center justify-center p-6">
        <div class="glass-card p-10 w-full max-w-md text-white text-center">
            <div class="text-8xl mb-6">⚔️</div>
            <h1 class="text-4xl font-bold mb-6 war-title">جنگ جهانی سوم</h1>
            <div class="loading-spinner mx-auto mb-6"></div>
            <p class="text-slate-300 text-lg mb-4" id="loadingText">در حال اتصال به سرور...</p>
            <p class="text-sm text-yellow-400 mb-6">لطفاً فیلتر شکن را روشن کنید</p>
            <button id="retryBtn" onclick="initializeFirebase()" class="war-btn hidden">
                🔄 تلاش مجدد
            </button>
        </div>
    </div>

    <!-- صفحه لاگین -->
    <div id="loginPage" class="min-h-screen flex items-center justify-center p-6 hidden">
        <div class="glass-card p-10 w-full max-w-md text-white">
            <div class="text-center mb-10">
                <div class="text-8xl mb-6">⚔️</div>
                <h1 class="text-4xl font-bold mb-4 war-title">جنگ جهانی سوم</h1>
                <p class="text-slate-300 text-lg">ورود به میدان نبرد</p>
            </div>
            
            <form id="loginForm" class="space-y-6">
                <div>
                    <label class="block text-sm font-medium text-slate-300 mb-3">نام کاربری</label>
                    <input type="text" id="username" class="war-input" placeholder="نام کاربری خود را وارد کنید">
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-300 mb-3">رمز عبور</label>
                    <input type="password" id="password" class="war-input" placeholder="رمز عبور خود را وارد کنید">
                </div>
                <button type="submit" class="war-btn w-full py-4 text-lg">
                    🚀 ورود به جنگ
                </button>
            </form>
            
            <div class="mt-8 text-center">
                <p class="text-xs text-slate-400">فقط برای فرماندهان مجاز</p>
            </div>
        </div>
    </div>

    <!-- پنل ادمین -->
    <div id="adminPanel" class="hidden">
        <nav class="navbar p-4">
            <div class="flex justify-between items-center">
                <h1 class="text-3xl font-bold text-white flex items-center gap-4">
                    <span class="text-4xl">👑</span>
                    فرماندهی کل
                </h1>
                <div class="flex items-center gap-4">
                    <button class="md:hidden hamburger" onclick="toggleMobileMenu()" id="adminMenuToggle">
                        <span></span>
                        <span></span>
                        <span></span>
                    </button>
                    <button onclick="logout()" class="war-btn">
                        🚪 خروج
                    </button>
                </div>
            </div>
        </nav>
        
        <div class="flex">
            <div class="sidebar w-72 hidden md:block" id="adminSidebar">
                <div class="p-6">
                    <div class="space-y-3">
                        <div onclick="showAdminSection('countries')" class="sidebar-item active" data-section="countries">
                            <span class="text-3xl">🌍</span>
                            <span>مدیریت کشورها</span>
                        </div>
                        <div onclick="showAdminSection('economy')" class="sidebar-item" data-section="economy">
                            <span class="text-3xl">💰</span>
                            <span>مدیریت اقتصاد</span>
                        </div>
                        <div onclick="showAdminSection('news')" class="sidebar-item" data-section="news">
                            <span class="text-3xl">📰</span>
                            <span>مدیریت اخبار</span>
                        </div>
                        <div onclick="showAdminSection('addCountry')" class="sidebar-item" data-section="addCountry">
                            <span class="text-3xl">➕</span>
                            <span>افزودن کشور</span>
                        </div>
                        <div onclick="showAdminSection('statistics')" class="sidebar-item" data-section="statistics">
                            <span class="text-3xl">📊</span>
                            <span>آمار کلی</span>
                        </div>
                        <div onclick="showAdminSection('gameControl')" class="sidebar-item" data-section="gameControl">
                            <span class="text-3xl">🎮</span>
                            <span>کنترل بازی</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- منوی موبایل ادمین -->
            <div class="mobile-menu" id="adminMobileMenu">
                <div class="p-6">
                    <div class="space-y-3">
                        <div onclick="showAdminSection('countries'); closeMobileMenu()" class="sidebar-item active" data-section="countries">
                            <span class="text-3xl">🌍</span>
                            <span>مدیریت کشورها</span>
                        </div>
                        <div onclick="showAdminSection('economy'); closeMobileMenu()" class="sidebar-item" data-section="economy">
                            <span class="text-3xl">💰</span>
                            <span>مدیریت اقتصاد</span>
                        </div>
                        <div onclick="showAdminSection('news'); closeMobileMenu()" class="sidebar-item" data-section="news">
                            <span class="text-3xl">📰</span>
                            <span>مدیریت اخبار</span>
                        </div>
                        <div onclick="showAdminSection('addCountry'); closeMobileMenu()" class="sidebar-item" data-section="addCountry">
                            <span class="text-3xl">➕</span>
                            <span>افزودن کشور</span>
                        </div>
                        <div onclick="showAdminSection('statistics'); closeMobileMenu()" class="sidebar-item" data-section="statistics">
                            <span class="text-3xl">📊</span>
                            <span>آمار کلی</span>
                        </div>
                        <div onclick="showAdminSection('gameControl'); closeMobileMenu()" class="sidebar-item" data-section="gameControl">
                            <span class="text-3xl">🎮</span>
                            <span>کنترل بازی</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="flex-1 p-6 main-content" style="margin-right: 288px;">
                <!-- مدیریت کشورها -->
                <div id="adminCountries" class="admin-section">
                    <h2 class="text-3xl font-bold text-white mb-8 flex items-center gap-4">
                        <span class="text-4xl">🌍</span>
                        مدیریت کشورها
                    </h2>
                    <div id="countriesList" class="grid gap-6 md:grid-cols-2 lg:grid-cols-3"></div>
                </div>

                <!-- مدیریت اقتصاد -->
                <div id="adminEconomy" class="admin-section hidden">
                    <h2 class="text-3xl font-bold text-white mb-8 flex items-center gap-4">
                        <span class="text-4xl">💰</span>
                        مدیریت اقتصاد
                    </h2>
                    <div class="glass-card p-8 max-w-4xl text-white">
                        <h3 class="text-xl font-bold mb-6">انتخاب کشور</h3>
                        <select id="countrySelect" class="war-input mb-8">
                            <option value="">کشور را انتخاب کنید...</option>
                        </select>
                        <div id="countryEconomyForm" class="hidden space-y-8">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                <div>
                                    <label class="block text-sm font-medium text-slate-300 mb-3">پول (میلیارد دلار)</label>
                                    <input type="number" id="adminMoney" class="war-input">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-300 mb-3">فناوری (%)</label>
                                    <input type="number" id="adminTech" class="war-input">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-300 mb-3">دفاع (%)</label>
                                    <input type="number" id="adminDefense" class="war-input">
                                </div>
                            </div>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-6">
                                <div>
                                    <label class="block text-sm font-medium text-slate-300 mb-3">موشک</label>
                                    <input type="number" id="adminMissiles" class="war-input">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-300 mb-3">سرباز</label>
                                    <input type="number" id="adminSoldiers" class="war-input">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-300 mb-3">بمب‌افکن</label>
                                    <input type="number" id="adminBombers" class="war-input">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-300 mb-3">جنگنده</label>
                                    <input type="number" id="adminFighters" class="war-input">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-300 mb-3">تانک</label>
                                    <input type="number" id="adminTanks" class="war-input">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-300 mb-3">ناو جنگی</label>
                                    <input type="number" id="adminWarships" class="war-input">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-300 mb-3">پدافند هوایی</label>
                                    <input type="number" id="adminAirDefense" class="war-input">
                                </div>
                            </div>
                            <button onclick="updateCountryEconomy()" class="admin-btn">
                                ✅ به‌روزرسانی کامل
                            </button>
                        </div>
                    </div>
                </div>

                <!-- مدیریت اخبار -->
                <div id="adminNews" class="admin-section hidden">
                    <h2 class="text-3xl font-bold text-white mb-8 flex items-center gap-4">
                        <span class="text-4xl">📰</span>
                        مدیریت اخبار
                    </h2>
                    <div id="adminNewsList" class="space-y-6"></div>
                </div>

                <!-- افزودن کشور -->
                <div id="adminAddCountry" class="admin-section hidden">
                    <h2 class="text-3xl font-bold text-white mb-8 flex items-center gap-4">
                        <span class="text-4xl">➕</span>
                        افزودن کشور جدید
                    </h2>
                    <div class="glass-card p-8 max-w-3xl text-white">
                        <div class="space-y-6">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                <div>
                                    <label class="block text-sm font-medium text-slate-300 mb-3">نام کشور</label>
                                    <input type="text" id="newCountryName" class="war-input" placeholder="نام کشور را وارد کنید">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-300 mb-3">نام کاربری</label>
                                    <input type="text" id="newCountryUsername" class="war-input" placeholder="نام کاربری را وارد کنید">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-300 mb-3">رمز عبور</label>
                                    <input type="password" id="newCountryPassword" class="war-input" placeholder="رمز عبور را وارد کنید">
                                </div>
                            </div>
                            <button onclick="addNewCountry()" class="admin-btn w-full py-4">
                                ➕ ایجاد کشور جدید
                            </button>
                        </div>
                    </div>
                </div>

                <!-- آمار کلی -->
                <div id="adminStatistics" class="admin-section hidden">
                    <h2 class="text-3xl font-bold text-white mb-8 flex items-center gap-4">
                        <span class="text-4xl">📊</span>
                        آمار کلی بازی
                    </h2>
                    <div id="globalStats" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6"></div>
                </div>

                <!-- کنترل بازی -->
                <div id="adminGameControl" class="admin-section hidden">
                    <h2 class="text-3xl font-bold text-white mb-8 flex items-center gap-4">
                        <span class="text-4xl">🎮</span>
                        کنترل کلی بازی
                    </h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div class="glass-card p-8 text-white">
                            <h3 class="text-xl font-bold mb-6 flex items-center gap-3">
                                <span class="text-3xl">🔴</span>
                                خاموش کردن بازی
                            </h3>
                            <p class="text-slate-300 mb-6">با خاموش کردن بازی، تمام بازیکنان فقط می‌توانند آمار خود را مشاهده کنند و امکان حمله، تجارت و صدور بیانیه را نخواهند داشت.</p>
                            <button onclick="toggleGameStatus(false)" class="war-btn w-full py-4">
                                🔴 خاموش کردن بازی
                            </button>
                        </div>
                        <div class="glass-card p-8 text-white">
                            <h3 class="text-xl font-bold mb-6 flex items-center gap-3">
                                <span class="text-3xl">🟢</span>
                                روشن کردن بازی
                            </h3>
                            <p class="text-slate-300 mb-6">با روشن کردن بازی، تمام بازیکنان دسترسی کامل به امکانات بازی خواهند داشت و می‌توانند حمله، تجارت و صدور بیانیه انجام دهند.</p>
                            <button onclick="toggleGameStatus(true)" class="peace-btn w-full py-4">
                                🟢 روشن کردن بازی
                            </button>
                        </div>
                    </div>
                    <div class="glass-card p-8 mt-8 text-white">
                        <h3 class="text-xl font-bold mb-4 flex items-center gap-3">
                            <span class="text-3xl">📊</span>
                            وضعیت فعلی بازی
                        </h3>
                        <div id="gameStatusDisplay" class="text-center">
                            <div class="text-6xl mb-4" id="gameStatusIcon">🟢</div>
                            <p class="text-2xl font-bold" id="gameStatusText">بازی روشن است</p>
                            <p class="text-slate-300 mt-2" id="gameStatusDesc">بازیکنان دسترسی کامل به امکانات دارند</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- پنل بازیکن -->
    <div id="playerPanel" class="hidden">
        <nav class="navbar p-4">
            <div class="flex justify-between items-center">
                <h1 class="text-3xl font-bold text-white flex items-center gap-4" id="countryTitle">
                    <span class="text-4xl">🏴</span>
                    فرماندهی کشور
                </h1>
                <div class="flex items-center gap-4">
                    <button class="md:hidden hamburger" onclick="toggleMobileMenu()" id="playerMenuToggle">
                        <span></span>
                        <span></span>
                        <span></span>
                    </button>
                    <button onclick="logout()" class="war-btn">
                        🚪 خروج
                    </button>
                </div>
            </div>
        </nav>
        
        <div class="flex">
            <div class="sidebar w-72 hidden md:block" id="playerSidebar">
                <div class="p-6">
                    <div class="space-y-3">
                        <div onclick="showPlayerSection('dashboard')" class="sidebar-item active" data-section="dashboard">
                            <span class="text-3xl">📊</span>
                            <span>وضعیت کشور</span>
                        </div>
                        <div onclick="showPlayerSection('blackmarket')" class="sidebar-item" data-section="blackmarket">
                            <span class="text-3xl">🛒</span>
                            <span>بازار سیاه</span>
                        </div>
                        <div onclick="showPlayerSection('statement')" class="sidebar-item" data-section="statement">
                            <span class="text-3xl">📢</span>
                            <span>صدور بیانیه</span>
                        </div>
                        <div onclick="showPlayerSection('trade')" class="sidebar-item" data-section="trade">
                            <span class="text-3xl">🤝</span>
                            <span>تجارت</span>
                        </div>
                        <div onclick="showPlayerSection('attack')" class="sidebar-item" data-section="attack">
                            <span class="text-3xl">⚔️</span>
                            <span>حمله نظامی</span>
                        </div>
                        <div onclick="showPlayerSection('news')" class="sidebar-item" data-section="news">
                            <span class="text-3xl">📰</span>
                            <span>اخبار جهانی</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- منوی موبایل بازیکن -->
            <div class="mobile-menu" id="playerMobileMenu">
                <div class="p-6">
                    <div class="space-y-3">
                        <div onclick="showPlayerSection('dashboard'); closeMobileMenu()" class="sidebar-item active" data-section="dashboard">
                            <span class="text-3xl">📊</span>
                            <span>وضعیت کشور</span>
                        </div>
                        <div onclick="showPlayerSection('blackmarket'); closeMobileMenu()" class="sidebar-item" data-section="blackmarket">
                            <span class="text-3xl">🛒</span>
                            <span>بازار سیاه</span>
                        </div>
                        <div onclick="showPlayerSection('statement'); closeMobileMenu()" class="sidebar-item" data-section="statement">
                            <span class="text-3xl">📢</span>
                            <span>صدور بیانیه</span>
                        </div>
                        <div onclick="showPlayerSection('trade'); closeMobileMenu()" class="sidebar-item" data-section="trade">
                            <span class="text-3xl">🤝</span>
                            <span>تجارت</span>
                        </div>
                        <div onclick="showPlayerSection('attack'); closeMobileMenu()" class="sidebar-item" data-section="attack">
                            <span class="text-3xl">⚔️</span>
                            <span>حمله نظامی</span>
                        </div>
                        <div onclick="showPlayerSection('news'); closeMobileMenu()" class="sidebar-item" data-section="news">
                            <span class="text-3xl">📰</span>
                            <span>اخبار جهانی</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="flex-1 p-6 main-content" style="margin-right: 288px;">
                <!-- وضعیت کشور -->
                <div id="playerDashboard" class="player-section">
                    <h2 class="text-3xl font-bold text-white mb-8 flex items-center gap-4">
                        <span class="text-4xl">📊</span>
                        وضعیت فعلی کشور
                    </h2>
                    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-6" id="statsGrid"></div>
                </div>

                <!-- بازار سیاه -->
                <div id="playerBlackmarket" class="player-section hidden">
                    <h2 class="text-3xl font-bold text-white mb-8 flex items-center gap-4">
                        <span class="text-4xl">🛒</span>
                        بازار سیاه تسلیحات
                    </h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-8">
                        <div class="weapon-card text-white">
                            <div class="text-center mb-6">
                                <div class="text-6xl mb-4">🚀</div>
                                <h3 class="text-xl font-bold mb-3">موشک بالستیک</h3>
                                <p class="text-red-400 font-bold text-lg">۱۰۰ میلیارد دلار</p>
                            </div>
                            <input type="number" id="missileQty" placeholder="تعداد" class="war-input mb-6">
                            <button onclick="buyWeapon('missiles', 100)" class="war-btn w-full">
                                💰 خرید
                            </button>
                        </div>
                        <div class="weapon-card text-white">
                            <div class="text-center mb-6">
                                <div class="text-6xl mb-4">👥</div>
                                <h3 class="text-xl font-bold mb-3">سرباز نخبه</h3>
                                <p class="text-red-400 font-bold text-lg">۲ میلیارد دلار</p>
                            </div>
                            <input type="number" id="soldierQty" placeholder="تعداد" class="war-input mb-6">
                            <button onclick="buyWeapon('soldiers', 2)" class="war-btn w-full">
                                💰 خرید
                            </button>
                        </div>
                        <div class="weapon-card text-white">
                            <div class="text-center mb-6">
                                <div class="text-6xl mb-4">✈️</div>
                                <h3 class="text-xl font-bold mb-3">بمب‌افکن استراتژیک</h3>
                                <p class="text-red-400 font-bold text-lg">۵۰۰ میلیارد دلار</p>
                            </div>
                            <input type="number" id="bomberQty" placeholder="تعداد" class="war-input mb-6">
                            <button onclick="buyWeapon('bombers', 500)" class="war-btn w-full">
                                💰 خرید
                            </button>
                        </div>
                        <div class="weapon-card text-white">
                            <div class="text-center mb-6">
                                <div class="text-6xl mb-4">🛩️</div>
                                <h3 class="text-xl font-bold mb-3">جنگنده نسل پنج</h3>
                                <p class="text-red-400 font-bold text-lg">۳۰۰ میلیارد دلار</p>
                            </div>
                            <input type="number" id="fighterQty" placeholder="تعداد" class="war-input mb-6">
                            <button onclick="buyWeapon('fighters', 300)" class="war-btn w-full">
                                💰 خرید
                            </button>
                        </div>
                        <div class="weapon-card text-white">
                            <div class="text-center mb-6">
                                <div class="text-6xl mb-4">🚗</div>
                                <h3 class="text-xl font-bold mb-3">تانک پیشرفته</h3>
                                <p class="text-red-400 font-bold text-lg">۸۰ میلیارد دلار</p>
                            </div>
                            <input type="number" id="tankQty" placeholder="تعداد" class="war-input mb-6">
                            <button onclick="buyWeapon('tanks', 80)" class="war-btn w-full">
                                💰 خرید
                            </button>
                        </div>
                        <div class="weapon-card text-white">
                            <div class="text-center mb-6">
                                <div class="text-6xl mb-4">🚢</div>
                                <h3 class="text-xl font-bold mb-3">ناو جنگی</h3>
                                <p class="text-red-400 font-bold text-lg">۱۲۰۰ میلیارد دلار</p>
                            </div>
                            <input type="number" id="warshipQty" placeholder="تعداد" class="war-input mb-6">
                            <button onclick="buyWeapon('warships', 1200)" class="war-btn w-full">
                                💰 خرید
                            </button>
                        </div>
                        <div class="weapon-card text-white">
                            <div class="text-center mb-6">
                                <div class="text-6xl mb-4">🛡️</div>
                                <h3 class="text-xl font-bold mb-3">سامانه پدافند</h3>
                                <p class="text-red-400 font-bold text-lg">۲۰۰ میلیارد دلار</p>
                            </div>
                            <input type="number" id="defenseQty" placeholder="تعداد" class="war-input mb-6">
                            <button onclick="buyWeapon('airDefense', 200)" class="war-btn w-full">
                                💰 خرید
                            </button>
                        </div>
                    </div>
                </div>

                <!-- صدور بیانیه -->
                <div id="playerStatement" class="player-section hidden">
                    <h2 class="text-3xl font-bold text-white mb-8 flex items-center gap-4">
                        <span class="text-4xl">📢</span>
                        صدور بیانیه رسمی
                    </h2>
                    <div class="glass-card p-8 max-w-4xl text-white">
                        <textarea id="statementText" placeholder="پیام خود را به جهان اعلام کنید..." class="war-input h-40 mb-6 resize-none"></textarea>
                        <button onclick="publishStatement()" class="peace-btn">
                            📢 انتشار بیانیه
                        </button>
                    </div>
                </div>

                <!-- تجارت -->
                <div id="playerTrade" class="player-section hidden">
                    <h2 class="text-3xl font-bold text-white mb-8 flex items-center gap-4">
                        <span class="text-4xl">🤝</span>
                        سیستم تجارت بین‌المللی
                    </h2>
                    <div class="grid md:grid-cols-2 gap-8">
                        <div class="trade-card p-8 text-white">
                            <h3 class="text-xl font-bold mb-6 flex items-center gap-3">
                                <span class="text-3xl">📤</span>
                                درخواست تجارت جدید
                            </h3>
                            <div class="space-y-6">
                                <select id="tradeCountry" class="war-input">
                                    <option value="">کشور مقصد را انتخاب کنید...</option>
                                </select>
                                <div class="grid grid-cols-1 gap-6">
                                    <div>
                                        <label class="block text-sm font-medium text-slate-300 mb-3">پیشنهاد شما</label>
                                        <input type="text" id="tradeGive" placeholder="مثال: ۵۰۰ میلیارد دلار" class="war-input">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-slate-300 mb-3">درخواست شما</label>
                                        <input type="text" id="tradeReceive" placeholder="مثال: ۱۰۰ موشک بالستیک" class="war-input">
                                    </div>
                                </div>
                                <button onclick="sendTradeRequest()" class="peace-btn w-full">
                                    📤 ارسال درخواست
                                </button>
                            </div>
                        </div>
                        <div class="trade-card p-8 text-white">
                            <h3 class="text-xl font-bold mb-6 flex items-center gap-3">
                                <span class="text-3xl">📥</span>
                                درخواست‌های دریافتی
                            </h3>
                            <div id="tradeRequests" class="space-y-6"></div>
                        </div>
                    </div>
                </div>

                <!-- حمله نظامی -->
                <div id="playerAttack" class="player-section hidden">
                    <h2 class="text-3xl font-bold text-white mb-8 flex items-center gap-4">
                        <span class="text-4xl">⚔️</span>
                        عملیات نظامی
                    </h2>
                    <div class="attack-card p-8 max-w-4xl text-white">
                        <div class="space-y-6">
                            <div>
                                <label class="block text-sm font-medium text-slate-300 mb-3">کشور هدف</label>
                                <select id="attackTarget" class="war-input">
                                    <option value="">هدف را انتخاب کنید...</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-300 mb-3">نوع عملیات</label>
                                <select id="attackType" class="war-input" onchange="updateAttackForm()">
                                    <option value="">نوع حمله را انتخاب کنید...</option>
                                    <option value="air">حمله هوایی ✈️</option>
                                    <option value="land">حمله زمینی 🚗</option>
                                    <option value="sea">حمله دریایی 🚢</option>
                                </select>
                            </div>
                            
                            <!-- فرم حمله هوایی -->
                            <div id="airAttackForm" class="hidden">
                                <h3 class="text-xl font-bold mb-4 text-red-400">🛩️ تجهیزات مورد نیاز برای حمله هوایی</h3>
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                    <div>
                                        <label class="block text-sm font-medium text-slate-300 mb-3">جنگنده (موجود: ${currentCountry?.fighters || 0})</label>
                                        <input type="number" id="airFighters" class="war-input" placeholder="تعداد جنگنده" min="1">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-slate-300 mb-3">بمب‌افکن (موجود: ${currentCountry?.bombers || 0})</label>
                                        <input type="number" id="airBombers" class="war-input" placeholder="تعداد بمب‌افکن" min="1">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-slate-300 mb-3">موشک (موجود: ${currentCountry?.missiles || 0})</label>
                                        <input type="number" id="airMissiles" class="war-input" placeholder="تعداد موشک" min="1">
                                    </div>
                                </div>
                            </div>
                            
                            <!-- فرم حمله زمینی -->
                            <div id="landAttackForm" class="hidden">
                                <h3 class="text-xl font-bold mb-4 text-red-400">🚗 تجهیزات مورد نیاز برای حمله زمینی</h3>
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                    <div>
                                        <label class="block text-sm font-medium text-slate-300 mb-3">تانک (موجود: ${currentCountry?.tanks || 0})</label>
                                        <input type="number" id="landTanks" class="war-input" placeholder="تعداد تانک" min="1">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-slate-300 mb-3">سرباز (موجود: ${currentCountry?.soldiers || 0})</label>
                                        <input type="number" id="landSoldiers" class="war-input" placeholder="تعداد سرباز" min="1000">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-slate-300 mb-3">موشک (موجود: ${currentCountry?.missiles || 0})</label>
                                        <input type="number" id="landMissiles" class="war-input" placeholder="تعداد موشک" min="1">
                                    </div>
                                </div>
                            </div>
                            
                            <!-- فرم حمله دریایی -->
                            <div id="seaAttackForm" class="hidden">
                                <h3 class="text-xl font-bold mb-4 text-red-400">🚢 تجهیزات مورد نیاز برای حمله دریایی</h3>
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                    <div>
                                        <label class="block text-sm font-medium text-slate-300 mb-3">ناو جنگی (موجود: ${currentCountry?.warships || 0})</label>
                                        <input type="number" id="seaWarships" class="war-input" placeholder="تعداد ناو جنگی" min="1">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-slate-300 mb-3">موشک (موجود: ${currentCountry?.missiles || 0})</label>
                                        <input type="number" id="seaMissiles" class="war-input" placeholder="تعداد موشک" min="1">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-slate-300 mb-3">جنگنده (موجود: ${currentCountry?.fighters || 0})</label>
                                        <input type="number" id="seaFighters" class="war-input" placeholder="تعداد جنگنده" min="1">
                                    </div>
                                </div>
                            </div>
                            
                            <button onclick="launchAttack()" class="war-btn w-full py-4 text-lg">
                                🚀 شروع عملیات
                            </button>
                        </div>
                    </div>
                </div>

                <!-- اخبار جهانی -->
                <div id="playerNews" class="player-section hidden">
                    <h2 class="text-3xl font-bold text-white mb-8 flex items-center gap-4">
                        <span class="text-4xl">📰</span>
                        اخبار جهانی
                    </h2>
                    <div id="newsList" class="space-y-6"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // تنظیمات Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyB3-grIuRV6LuJffSAhPfkkHPh6LkG9ft0",
            authDomain: "ww3-game-723e0.firebaseapp.com",
            projectId: "ww3-game-723e0",
            storageBucket: "ww3-game-723e0.firebasestorage.app",
            messagingSenderId: "296416147743",
            appId: "1:296416147743:web:eb9badd47253aec554582a",
            measurementId: "G-PPEN4R8HM0"
        };

        let db = null;
        let currentUser = null;
        let currentCountry = null;
        let gameEnabled = true;

        // آمار پیش‌فرض کشورها
        const countryDefaults = {
            'آمریکا': { money: 5000, technology: 95, defense: 90, missiles: 1200, soldiers: 1500000, bombers: 500, fighters: 2000, tanks: 8000, warships: 300, airDefense: 600 },
            'روسیه': { money: 3000, technology: 88, defense: 85, missiles: 1000, soldiers: 1200000, bombers: 400, fighters: 1200, tanks: 6000, warships: 200, airDefense: 500 },
            'چین': { money: 4000, technology: 85, defense: 80, missiles: 800, soldiers: 2500000, bombers: 300, fighters: 1500, tanks: 7000, warships: 250, airDefense: 450 },
            'ایران': { money: 800, technology: 70, defense: 75, missiles: 400, soldiers: 600000, bombers: 80, fighters: 300, tanks: 1500, warships: 50, airDefense: 300 },
            'انگلیس': { money: 1500, technology: 90, defense: 85, missiles: 500, soldiers: 300000, bombers: 150, fighters: 600, tanks: 2000, warships: 120, airDefense: 350 },
            'فرانسه': { money: 1400, technology: 88, defense: 82, missiles: 450, soldiers: 280000, bombers: 140, fighters: 550, tanks: 1800, warships: 100, airDefense: 320 },
            'آلمان': { money: 1800, technology: 92, defense: 80, missiles: 300, soldiers: 250000, bombers: 100, fighters: 500, tanks: 1600, warships: 80, airDefense: 300 },
            'ژاپن': { money: 2200, technology: 93, defense: 78, missiles: 200, soldiers: 350000, bombers: 90, fighters: 700, tanks: 1000, warships: 150, airDefense: 280 },
            'کره جنوبی': { money: 1200, technology: 85, defense: 75, missiles: 250, soldiers: 700000, bombers: 70, fighters: 400, tanks: 2000, warships: 60, airDefense: 250 },
            'اسرائیل': { money: 600, technology: 90, defense: 95, missiles: 600, soldiers: 200000, bombers: 80, fighters: 350, tanks: 800, warships: 30, airDefense: 400 },
            'ترکیه': { money: 700, technology: 75, defense: 70, missiles: 300, soldiers: 500000, bombers: 60, fighters: 250, tanks: 1200, warships: 40, airDefense: 200 },
            'عربستان': { money: 1000, technology: 65, defense: 65, missiles: 200, soldiers: 400000, bombers: 50, fighters: 200, tanks: 1000, warships: 35, airDefense: 180 }
        };

        // اتصال به Firebase
        async function initializeFirebase() {
            try {
                document.getElementById('loadingText').textContent = 'در حال اتصال به سرور...';
                document.getElementById('retryBtn').classList.add('hidden');
                
                firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
                
                // تست اتصال
                document.getElementById('loadingText').textContent = 'در حال تست اتصال...';
                await db.collection('test').doc('connection').set({
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    status: 'connected'
                });
                
                document.getElementById('loadingText').textContent = 'در حال بارگذاری داده‌های بازی...';
                await initializeGameData();
                
                document.getElementById('loadingText').textContent = 'اتصال برقرار شد! ✅';
                
                setTimeout(() => {
                    document.getElementById('loadingPage').classList.add('hidden');
                    document.getElementById('loginPage').classList.remove('hidden');
                }, 1500);
                
                console.log('✅ Firebase connected successfully');
                
            } catch (error) {
                console.error('❌ Firebase connection failed:', error);
                document.getElementById('loadingText').textContent = 'خطا در اتصال به سرور! ❌';
                document.getElementById('retryBtn').classList.remove('hidden');
            }
        }

        // مقداردهی اولیه داده‌ها
        async function initializeGameData() {
            try {
                const countriesSnapshot = await db.collection('countries').get();
                
                if (countriesSnapshot.empty) {
                    console.log('🔄 Initializing game data...');
                    const initialCountries = [
                        {
                            id: 'iran',
                            name: 'ایران',
                            username: 'iran',
                            password: 'iran123',
                            ...countryDefaults['ایران']
                        },
                        {
                            id: 'usa',
                            name: 'آمریکا',
                            username: 'usa',
                            password: 'usa123',
                            ...countryDefaults['آمریکا']
                        },
                        {
                            id: 'russia',
                            name: 'روسیه',
                            username: 'russia',
                            password: 'russia123',
                            ...countryDefaults['روسیه']
                        }
                    ];

                    const batch = db.batch();
                    for (const country of initialCountries) {
                        const countryRef = db.collection('countries').doc(country.id);
                        batch.set(countryRef, country);
                    }
                    await batch.commit();
                    
                    console.log('✅ Game data initialized');
                } else {
                    console.log('✅ Game data already exists');
                }
            } catch (error) {
                console.error('❌ Error initializing game data:', error);
            }
        }

        // تغییر وضعیت منوی موبایل
        function toggleMobileMenu() {
            const adminMenu = document.getElementById('adminMobileMenu');
            const playerMenu = document.getElementById('playerMobileMenu');
            const adminToggle = document.getElementById('adminMenuToggle');
            const playerToggle = document.getElementById('playerMenuToggle');
            
            if (adminMenu && !document.getElementById('adminPanel').classList.contains('hidden')) {
                adminMenu.classList.toggle('open');
                if (adminToggle) adminToggle.classList.toggle('active');
            }
            if (playerMenu && !document.getElementById('playerPanel').classList.contains('hidden')) {
                playerMenu.classList.toggle('open');
                if (playerToggle) playerToggle.classList.toggle('active');
            }
        }

        function closeMobileMenu() {
            const adminMenu = document.getElementById('adminMobileMenu');
            const playerMenu = document.getElementById('playerMobileMenu');
            const adminToggle = document.getElementById('adminMenuToggle');
            const playerToggle = document.getElementById('playerMenuToggle');
            
            if (adminMenu) {
                adminMenu.classList.remove('open');
                if (adminToggle) adminToggle.classList.remove('active');
            }
            if (playerMenu) {
                playerMenu.classList.remove('open');
                if (playerToggle) playerToggle.classList.remove('active');
            }
        }

        // ورود
        document.getElementById('loginForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value.trim();

            if (!username || !password) {
                alert('لطفاً تمام فیلدها را پر کنید! ⚠️');
                return;
            }

            const submitBtn = e.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = 'در حال اتصال... ⏳';
            submitBtn.disabled = true;

            try {
                if (username === 'admin' && password === 'admin123') {
                    currentUser = 'admin';
                    showAdminPanel();
                } else {
                    const countriesSnapshot = await db.collection('countries').get();
                    let foundCountry = null;
                    
                    countriesSnapshot.forEach(doc => {
                        const country = doc.data();
                        if (country.username === username && country.password === password) {
                            foundCountry = { id: doc.id, ...country };
                        }
                    });
                    
                    if (foundCountry) {
                        currentUser = foundCountry.id;
                        currentCountry = foundCountry;
                        showPlayerPanel();
                    } else {
                        alert('نام کاربری یا رمز عبور اشتباه است! 🚫');
                    }
                }
            } catch (error) {
                console.error('Login error:', error);
                alert('خطا در ورود! لطفاً دوباره تلاش کنید. ⚠️');
            } finally {
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        });

        // نمایش پنل ادمین
        function showAdminPanel() {
            document.getElementById('loginPage').classList.add('hidden');
            document.getElementById('adminPanel').classList.remove('hidden');
            loadAdminData();
        }

        // نمایش پنل بازیکن
        async function showPlayerPanel() {
            document.getElementById('loginPage').classList.add('hidden');
            document.getElementById('playerPanel').classList.remove('hidden');
            document.getElementById('countryTitle').innerHTML = `<span class="text-4xl">🏴</span> ${currentCountry.name}`;
            await checkGameStatus();
            loadPlayerData();
        }

        // خروج
        function logout() {
            currentUser = null;
            currentCountry = null;
            document.getElementById('adminPanel').classList.add('hidden');
            document.getElementById('playerPanel').classList.add('hidden');
            document.getElementById('loginPage').classList.remove('hidden');
            document.getElementById('loginForm').reset();
            closeMobileMenu();
        }

        // نمایش بخش‌های ادمین
        function showAdminSection(section) {
            document.querySelectorAll('.admin-section').forEach(s => s.classList.add('hidden'));
            document.getElementById('admin' + section.charAt(0).toUpperCase() + section.slice(1)).classList.remove('hidden');
            
            // به‌روزرسانی وضعیت فعال منو
            document.querySelectorAll('#adminSidebar .sidebar-item, #adminMobileMenu .sidebar-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelectorAll(`.sidebar-item[data-section="${section}"]`).forEach(item => {
                item.classList.add('active');
            });
            
            if (section === 'countries') loadCountriesList();
            if (section === 'economy') loadEconomySection();
            if (section === 'news') loadAdminNews();
            if (section === 'statistics') loadGlobalStats();
            if (section === 'gameControl') loadGameControlSection();
        }

        // نمایش بخش‌های بازیکن
        function showPlayerSection(section) {
            document.querySelectorAll('.player-section').forEach(s => s.classList.add('hidden'));
            document.getElementById('player' + section.charAt(0).toUpperCase() + section.slice(1)).classList.remove('hidden');
            
            // به‌روزرسانی وضعیت فعال منو
            document.querySelectorAll('#playerSidebar .sidebar-item, #playerMobileMenu .sidebar-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelectorAll(`.sidebar-item[data-section="${section}"]`).forEach(item => {
                item.classList.add('active');
            });
            
            if (section === 'dashboard') loadPlayerStats();
            if (section === 'trade') {
                loadTradeSection();
                // شروع به‌روزرسانی خودکار درخواست‌های تجارت
                startTradeRequestsAutoRefresh();
            } else {
                // توقف به‌روزرسانی خودکار اگر از بخش تجارت خارج شد
                stopTradeRequestsAutoRefresh();
            }
            if (section === 'attack') loadAttackSection();
            if (section === 'news') loadNews();
        }

        let tradeRequestsInterval = null;

        // شروع به‌روزرسانی خودکار درخواست‌های تجارت
        function startTradeRequestsAutoRefresh() {
            // پاک کردن interval قبلی اگر وجود داشت
            if (tradeRequestsInterval) {
                clearInterval(tradeRequestsInterval);
            }
            
            // به‌روزرسانی هر 10 ثانیه
            tradeRequestsInterval = setInterval(() => {
                if (!document.getElementById('playerTrade').classList.contains('hidden')) {
                    loadTradeRequests();
                }
            }, 10000);
        }

        // توقف به‌روزرسانی خودکار درخواست‌های تجارت
        function stopTradeRequestsAutoRefresh() {
            if (tradeRequestsInterval) {
                clearInterval(tradeRequestsInterval);
                tradeRequestsInterval = null;
            }
        }

        // بارگذاری داده‌های ادمین
        function loadAdminData() {
            loadCountriesList();
        }

        // بارگذاری لیست کشورها
        async function loadCountriesList() {
            try {
                const countriesSnapshot = await db.collection('countries').get();
                const container = document.getElementById('countriesList');
                
                const countriesHTML = [];
                countriesSnapshot.forEach(doc => {
                    const country = doc.data();
                    countriesHTML.push(`
                        <div class="glass-card p-8 text-white">
                            <div class="flex items-center gap-4 mb-6">
                                <div class="text-5xl">🏴</div>
                                <div>
                                    <h3 class="text-2xl font-bold">${country.name}</h3>
                                    <p class="text-slate-300 text-sm">کاربر: ${country.username}</p>
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-4 mb-6">
                                <div class="text-center">
                                    <p class="text-xs text-slate-400 mb-2">پول</p>
                                    <p class="text-lg font-bold text-green-400">${country.money} میلیارد</p>
                                </div>
                                <div class="text-center">
                                    <p class="text-xs text-slate-400 mb-2">فناوری</p>
                                    <p class="text-lg font-bold text-blue-400">${country.technology}%</p>
                                </div>
                                <div class="text-center">
                                    <p class="text-xs text-slate-400 mb-2">دفاع</p>
                                    <p class="text-lg font-bold text-yellow-400">${country.defense}%</p>
                                </div>
                                <div class="text-center">
                                    <p class="text-xs text-slate-400 mb-2">موشک</p>
                                    <p class="text-lg font-bold text-red-400">${country.missiles}</p>
                                </div>
                            </div>
                            <div class="flex gap-3">
                                <button onclick="editCountry('${doc.id}')" class="flex-1 neutral-btn text-sm">
                                    ✏️ ویرایش کامل
                                </button>
                                <button onclick="deleteCountry('${doc.id}')" class="flex-1 war-btn text-sm">
                                    🗑️ حذف
                                </button>
                            </div>
                        </div>
                    `);
                });
                
                container.innerHTML = countriesHTML.join('') || '<p class="text-slate-400 text-center text-2xl font-bold">کشوری یافت نشد</p>';
            } catch (error) {
                console.error('Error loading countries:', error);
            }
        }

        // ویرایش کامل کشور
        async function editCountry(countryId) {
            try {
                const countryDoc = await db.collection('countries').doc(countryId).get();
                if (!countryDoc.exists) {
                    alert('کشور یافت نشد! ❌');
                    return;
                }
                
                const country = countryDoc.data();
                
                // ایجاد فرم ویرایش
                const editFormDiv = document.createElement('div');
                editFormDiv.id = 'editFormModal';
                editFormDiv.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; display: flex; align-items: center; justify-content: center; padding: 20px;';
                
                editFormDiv.innerHTML = `
                    <div style="background: linear-gradient(135deg, rgba(15, 23, 42, 0.95) 0%, rgba(30, 41, 59, 0.95) 100%); border: 1px solid rgba(148, 163, 184, 0.3); border-radius: 20px; padding: 30px; max-width: 800px; width: 100%; max-height: 90vh; overflow-y: auto; color: white;">
                        <h2 style="text-align: center; margin-bottom: 30px; font-size: 24px; font-weight: bold;">ویرایش کامل کشور ${country.name}</h2>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                            <div>
                                <label style="display: block; margin-bottom: 8px; font-weight: bold;">نام کشور:</label>
                                <input type="text" id="editName" value="${country.name}" style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #444; background: rgba(0,0,0,0.3); color: white;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 8px; font-weight: bold;">نام کاربری:</label>
                                <input type="text" id="editUsername" value="${country.username}" style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #444; background: rgba(0,0,0,0.3); color: white;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 8px; font-weight: bold;">رمز عبور:</label>
                                <input type="text" id="editPassword" value="${country.password}" style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #444; background: rgba(0,0,0,0.3); color: white;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 8px; font-weight: bold;">پول (میلیارد):</label>
                                <input type="number" id="editMoney" value="${country.money}" style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #444; background: rgba(0,0,0,0.3); color: white;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 8px; font-weight: bold;">فناوری (%):</label>
                                <input type="number" id="editTech" value="${country.technology}" style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #444; background: rgba(0,0,0,0.3); color: white;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 8px; font-weight: bold;">دفاع (%):</label>
                                <input type="number" id="editDefense" value="${country.defense}" style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #444; background: rgba(0,0,0,0.3); color: white;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 8px; font-weight: bold;">موشک:</label>
                                <input type="number" id="editMissiles" value="${country.missiles}" style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #444; background: rgba(0,0,0,0.3); color: white;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 8px; font-weight: bold;">سرباز:</label>
                                <input type="number" id="editSoldiers" value="${country.soldiers}" style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #444; background: rgba(0,0,0,0.3); color: white;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 8px; font-weight: bold;">بمب‌افکن:</label>
                                <input type="number" id="editBombers" value="${country.bombers}" style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #444; background: rgba(0,0,0,0.3); color: white;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 8px; font-weight: bold;">جنگنده:</label>
                                <input type="number" id="editFighters" value="${country.fighters}" style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #444; background: rgba(0,0,0,0.3); color: white;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 8px; font-weight: bold;">تانک:</label>
                                <input type="number" id="editTanks" value="${country.tanks}" style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #444; background: rgba(0,0,0,0.3); color: white;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 8px; font-weight: bold;">ناو جنگی:</label>
                                <input type="number" id="editWarships" value="${country.warships}" style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #444; background: rgba(0,0,0,0.3); color: white;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 8px; font-weight: bold;">پدافند هوایی:</label>
                                <input type="number" id="editAirDefense" value="${country.airDefense || 0}" style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #444; background: rgba(0,0,0,0.3); color: white;">
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 15px; margin-top: 30px; justify-content: center;">
                            <button id="saveEditBtn" style="background: linear-gradient(135deg, #059669 0%, #047857 100%); color: white; padding: 15px 30px; border: none; border-radius: 12px; font-weight: bold; cursor: pointer;">
                                ✅ ذخیره تغییرات
                            </button>
                            <button id="cancelEditBtn" style="background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%); color: white; padding: 15px 30px; border: none; border-radius: 12px; font-weight: bold; cursor: pointer;">
                                ❌ انصراف
                            </button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(editFormDiv);
                
                // اضافه کردن event listeners
                document.getElementById('saveEditBtn').addEventListener('click', () => saveCountryEdit(countryId));
                document.getElementById('cancelEditBtn').addEventListener('click', closeEditForm);
                
            } catch (error) {
                console.error('Error loading country for edit:', error);
                alert('خطا در بارگذاری اطلاعات کشور! ❌');
            }
        }

        // ذخیره ویرایش کشور
        async function saveCountryEdit(countryId) {
            try {
                const updates = {
                    name: document.getElementById('editName').value.trim(),
                    username: document.getElementById('editUsername').value.trim(),
                    password: document.getElementById('editPassword').value.trim(),
                    money: parseInt(document.getElementById('editMoney').value) || 0,
                    technology: parseInt(document.getElementById('editTech').value) || 0,
                    defense: parseInt(document.getElementById('editDefense').value) || 0,
                    missiles: parseInt(document.getElementById('editMissiles').value) || 0,
                    soldiers: parseInt(document.getElementById('editSoldiers').value) || 0,
                    bombers: parseInt(document.getElementById('editBombers').value) || 0,
                    fighters: parseInt(document.getElementById('editFighters').value) || 0,
                    tanks: parseInt(document.getElementById('editTanks').value) || 0,
                    warships: parseInt(document.getElementById('editWarships').value) || 0,
                    airDefense: parseInt(document.getElementById('editAirDefense').value) || 0
                };

                if (!updates.name || !updates.username || !updates.password) {
                    alert('نام کشور، نام کاربری و رمز عبور الزامی است! ⚠️');
                    return;
                }

                await db.collection('countries').doc(countryId).update(updates);
                await addNews(`✏️ ادمین اطلاعات کامل کشور ${updates.name} را ویرایش کرد.`, 'سیستم');
                closeEditForm();
                loadCountriesList();
                alert('✅ کشور با موفقیت به‌روزرسانی شد! جزئیات در اخبار مشاهده کنید.');
                
            } catch (error) {
                console.error('Error saving country edit:', error);
                alert('❌ خطا در ذخیره تغییرات!');
            }
        }

        // بستن فرم ویرایش
        function closeEditForm() {
            const editForm = document.getElementById('editFormModal');
            if (editForm) {
                editForm.remove();
            }
        }

        // حذف کشور
        async function deleteCountry(countryId) {
            if (confirm('آیا مطمئن هستید که می‌خواهید این کشور را حذف کنید؟')) {
                try {
                    const countryDoc = await db.collection('countries').doc(countryId).get();
                    const countryName = countryDoc.data().name;
                    
                    await db.collection('countries').doc(countryId).delete();
                    await addNews(`🗑️ کشور ${countryName} توسط ادمین از بازی حذف شد.`, 'سیستم');
                    loadCountriesList();
                    alert('✅ کشور با موفقیت حذف شد! جزئیات در اخبار مشاهده کنید.');
                } catch (error) {
                    console.error('Error deleting country:', error);
                    alert('❌ خطا در حذف کشور!');
                }
            }
        }

        // بارگذاری بخش اقتصاد
        async function loadEconomySection() {
            try {
                const countriesSnapshot = await db.collection('countries').get();
                const select = document.getElementById('countrySelect');
                
                const options = ['<option value="">کشور را انتخاب کنید...</option>'];
                countriesSnapshot.forEach(doc => {
                    const country = doc.data();
                    options.push(`<option value="${doc.id}">${country.name}</option>`);
                });
                
                select.innerHTML = options.join('');
                
                select.addEventListener('change', async function() {
                    const countryId = this.value;
                    if (countryId) {
                        const countryDoc = await db.collection('countries').doc(countryId).get();
                        const country = countryDoc.data();
                        
                        document.getElementById('adminMoney').value = country.money;
                        document.getElementById('adminTech').value = country.technology;
                        document.getElementById('adminDefense').value = country.defense;
                        document.getElementById('adminMissiles').value = country.missiles;
                        document.getElementById('adminSoldiers').value = country.soldiers;
                        document.getElementById('adminBombers').value = country.bombers;
                        document.getElementById('adminFighters').value = country.fighters;
                        document.getElementById('adminTanks').value = country.tanks;
                        document.getElementById('adminWarships').value = country.warships;
                        document.getElementById('adminAirDefense').value = country.airDefense;
                        document.getElementById('countryEconomyForm').classList.remove('hidden');
                    }
                });
            } catch (error) {
                console.error('Error loading economy section:', error);
            }
        }

        // به‌روزرسانی کامل کشور
        async function updateCountryEconomy() {
            const countryId = document.getElementById('countrySelect').value;
            if (!countryId) return;

            try {
                const countryDoc = await db.collection('countries').doc(countryId).get();
                const countryName = countryDoc.data().name;
                
                const updates = {
                    money: parseInt(document.getElementById('adminMoney').value),
                    technology: parseInt(document.getElementById('adminTech').value),
                    defense: parseInt(document.getElementById('adminDefense').value),
                    missiles: parseInt(document.getElementById('adminMissiles').value),
                    soldiers: parseInt(document.getElementById('adminSoldiers').value),
                    bombers: parseInt(document.getElementById('adminBombers').value),
                    fighters: parseInt(document.getElementById('adminFighters').value),
                    tanks: parseInt(document.getElementById('adminTanks').value),
                    warships: parseInt(document.getElementById('adminWarships').value),
                    airDefense: parseInt(document.getElementById('adminAirDefense').value)
                };
                
                await db.collection('countries').doc(countryId).update(updates);
                await addNews(`⚙️ ادمین اطلاعات اقتصادی و نظامی ${countryName} را به‌روزرسانی کرد.`, 'سیستم');
                alert('✅ تمام اطلاعات با موفقیت به‌روزرسانی شد! جزئیات در اخبار مشاهده کنید.');
            } catch (error) {
                console.error('Error updating country economy:', error);
                alert('❌ خطا در به‌روزرسانی!');
            }
        }

        // افزودن کشور جدید
        async function addNewCountry() {
            const name = document.getElementById('newCountryName').value.trim();
            const username = document.getElementById('newCountryUsername').value.trim();
            const password = document.getElementById('newCountryPassword').value.trim();

            if (!name || !username || !password) {
                alert('❌ لطفاً تمام فیلدها را پر کنید!');
                return;
            }

            try {
                const existingCountry = await db.collection('countries').where('username', '==', username).get();
                if (!existingCountry.empty) {
                    alert('❌ این نام کاربری قبلاً استفاده شده است!');
                    return;
                }

                const defaultStats = countryDefaults[name] || {
                    money: 500,
                    technology: 60,
                    defense: 60,
                    missiles: 100,
                    soldiers: 300000,
                    bombers: 50,
                    fighters: 200,
                    tanks: 800,
                    warships: 25,
                    airDefense: 150
                };

                const newCountry = {
                    name: name,
                    username: username,
                    password: password,
                    ...defaultStats
                };

                await db.collection('countries').doc(username).set(newCountry);
                
                document.getElementById('newCountryName').value = '';
                document.getElementById('newCountryUsername').value = '';
                document.getElementById('newCountryPassword').value = '';
                
                await addNews(`🆕 کشور جدید ${name} به بازی پیوست و آماده مشارکت در جنگ جهانی سوم است.`, 'سیستم');
                
                alert('✅ کشور با موفقیت ایجاد شد! جزئیات در اخبار مشاهده کنید.');
            } catch (error) {
                console.error('Error adding new country:', error);
                alert('❌ خطا در ایجاد کشور!');
            }
        }

        // بارگذاری آمار کلی
        async function loadGlobalStats() {
            try {
                const countriesSnapshot = await db.collection('countries').get();
                const newsSnapshot = await db.collection('news').get();
                const tradeSnapshot = await db.collection('tradeRequests').get();
                
                let totalMoney = 0;
                let totalMissiles = 0;
                let totalSoldiers = 0;
                let totalCountries = 0;
                
                countriesSnapshot.forEach(doc => {
                    const country = doc.data();
                    totalMoney += country.money || 0;
                    totalMissiles += country.missiles || 0;
                    totalSoldiers += country.soldiers || 0;
                    totalCountries++;
                });
                
                const container = document.getElementById('globalStats');
                container.innerHTML = `
                    <div class="stat-card text-white">
                        <div class="text-5xl mb-4">🌍</div>
                        <h3 class="text-sm font-bold text-slate-300 mb-2">کل کشورها</h3>
                        <p class="text-3xl font-bold">${totalCountries}</p>
                    </div>
                    <div class="stat-card text-white">
                        <div class="text-5xl mb-4">💰</div>
                        <h3 class="text-sm font-bold text-slate-300 mb-2">کل پول جهان</h3>
                        <p class="text-3xl font-bold">${totalMoney.toLocaleString()}</p>
                    </div>
                    <div class="stat-card text-white">
                        <div class="text-5xl mb-4">🚀</div>
                        <h3 class="text-sm font-bold text-slate-300 mb-2">کل موشک‌ها</h3>
                        <p class="text-3xl font-bold">${totalMissiles.toLocaleString()}</p>
                    </div>
                    <div class="stat-card text-white">
                        <div class="text-5xl mb-4">👥</div>
                        <h3 class="text-sm font-bold text-slate-300 mb-2">کل سربازان</h3>
                        <p class="text-3xl font-bold">${totalSoldiers.toLocaleString()}</p>
                    </div>
                    <div class="stat-card text-white">
                        <div class="text-5xl mb-4">📰</div>
                        <h3 class="text-sm font-bold text-slate-300 mb-2">کل اخبار</h3>
                        <p class="text-3xl font-bold">${newsSnapshot.size}</p>
                    </div>
                    <div class="stat-card text-white">
                        <div class="text-5xl mb-4">🤝</div>
                        <h3 class="text-sm font-bold text-slate-300 mb-2">کل تجارت‌ها</h3>
                        <p class="text-3xl font-bold">${tradeSnapshot.size}</p>
                    </div>
                `;
            } catch (error) {
                console.error('Error loading global stats:', error);
            }
        }

        // بارگذاری اخبار ادمین
        async function loadAdminNews() {
            try {
                const newsSnapshot = await db.collection('news').orderBy('timestamp', 'desc').get();
                const container = document.getElementById('adminNewsList');
                
                const newsHTML = [];
                newsSnapshot.forEach(doc => {
                    const news = doc.data();
                    const date = news.timestamp ? news.timestamp.toDate().toLocaleDateString('fa-IR') + ' ' + news.timestamp.toDate().toLocaleTimeString('fa-IR') : 'نامشخص';
                    newsHTML.push(`
                        <div class="news-card p-8 text-white">
                            <div class="flex justify-between items-start">
                                <div class="flex-1">
                                    <p class="text-sm text-slate-400 mb-4 font-bold">${date}</p>
                                    <p class="text-white mb-4 text-lg font-semibold">${news.content}</p>
                                    <p class="text-sm text-green-400 font-bold">منبع: ${news.author}</p>
                                </div>
                                <button onclick="deleteNews('${doc.id}')" class="war-btn">
                                    🗑️ حذف
                                </button>
                            </div>
                        </div>
                    `);
                });
                
                container.innerHTML = newsHTML.join('') || '<p class="text-slate-400 text-center text-2xl font-bold">خبری یافت نشد</p>';
            } catch (error) {
                console.error('Error loading admin news:', error);
            }
        }

        // حذف خبر
        async function deleteNews(newsId) {
            try {
                await db.collection('news').doc(newsId).delete();
                loadAdminNews();
                alert('✅ خبر با موفقیت حذف شد!');
            } catch (error) {
                console.error('Error deleting news:', error);
                alert('❌ خطا در حذف خبر!');
            }
        }

        // بارگذاری داده‌های بازیکن
        function loadPlayerData() {
            loadPlayerStats();
        }

        // بارگذاری آمار بازیکن
        async function loadPlayerStats() {
            try {
                // به‌روزرسانی داده‌های فعلی از دیتابیس
                const countryDoc = await db.collection('countries').doc(currentUser).get();
                if (countryDoc.exists) {
                    currentCountry = { id: currentUser, ...countryDoc.data() };
                }
                
                const statsGrid = document.getElementById('statsGrid');
                
                const stats = [
                    { icon: '💰', label: 'پول', value: `${currentCountry.money} میلیارد`, color: 'green' },
                    { icon: '🔬', label: 'فناوری', value: `${currentCountry.technology}%`, color: 'blue' },
                    { icon: '🛡️', label: 'دفاع', value: `${currentCountry.defense}%`, color: 'yellow' },
                    { icon: '🚀', label: 'موشک', value: currentCountry.missiles, color: 'red' },
                    { icon: '👥', label: 'سرباز', value: currentCountry.soldiers.toLocaleString(), color: 'gray' },
                    { icon: '✈️', label: 'بمب‌افکن', value: currentCountry.bombers, color: 'purple' },
                    { icon: '🛩️', label: 'جنگنده', value: currentCountry.fighters, color: 'indigo' },
                    { icon: '🚗', label: 'تانک', value: currentCountry.tanks, color: 'orange' },
                    { icon: '🚢', label: 'ناو جنگی', value: currentCountry.warships, color: 'cyan' },
                    { icon: '🛡️', label: 'پدافند', value: currentCountry.airDefense, color: 'pink' }
                ];

                statsGrid.innerHTML = stats.map(stat => `
                    <div class="stat-card text-white">
                        <div class="text-5xl mb-4">${stat.icon}</div>
                        <h3 class="text-sm font-bold text-slate-300 mb-2">${stat.label}</h3>
                        <p class="text-2xl font-bold">${stat.value}</p>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading player stats:', error);
            }
        }

        // خرید سلاح
        async function buyWeapon(weaponType, price) {
            if (!checkGameAccess('خرید سلاح')) return;
            const qtyInput = document.getElementById(weaponType === 'missiles' ? 'missileQty' : 
                                                  weaponType === 'soldiers' ? 'soldierQty' :
                                                  weaponType === 'bombers' ? 'bomberQty' :
                                                  weaponType === 'fighters' ? 'fighterQty' :
                                                  weaponType === 'tanks' ? 'tankQty' :
                                                  weaponType === 'warships' ? 'warshipQty' :
                                                  'defenseQty');
            
            const quantity = parseInt(qtyInput.value);
            if (!quantity || quantity <= 0) {
                alert('❌ تعداد نامعتبر!');
                return;
            }

            const totalCost = price * quantity;
            if (currentCountry.money < totalCost) {
                alert('❌ پول کافی ندارید!');
                return;
            }

            try {
                const updates = {
                    money: currentCountry.money - totalCost
                };
                
                if (weaponType === 'airDefense') {
                    updates.airDefense = currentCountry.airDefense + quantity;
                    currentCountry.airDefense += quantity;
                } else {
                    updates[weaponType] = currentCountry[weaponType] + quantity;
                    currentCountry[weaponType] += quantity;
                }
                
                currentCountry.money -= totalCost;
                
                await db.collection('countries').doc(currentUser).update(updates);

                await addNews(`🛒 ${currentCountry.name} تعداد ${quantity} ${getWeaponName(weaponType)} به قیمت ${totalCost} میلیارد دلار از بازار سیاه خریداری کرد و قدرت نظامی خود را تقویت نمود.`, currentCountry.name);

                qtyInput.value = '';
                loadPlayerStats();
                alert(`✅ خرید موفق! ${quantity} ${getWeaponName(weaponType)} خریداری شد. جزئیات در اخبار مشاهده کنید.`);
            } catch (error) {
                console.error('Error buying weapon:', error);
                alert('❌ خطا در خرید!');
            }
        }

        // نام سلاح
        function getWeaponName(weaponType) {
            const names = {
                missiles: 'موشک بالستیک',
                soldiers: 'سرباز نخبه',
                bombers: 'بمب‌افکن استراتژیک',
                fighters: 'جنگنده نسل پنج',
                tanks: 'تانک پیشرفته',
                warships: 'ناو جنگی',
                airDefense: 'سامانه پدافند هوایی'
            };
            return names[weaponType] || weaponType;
        }

        // انتشار بیانیه
        async function publishStatement() {
            if (!checkGameAccess('صدور بیانیه')) return;
            const text = document.getElementById('statementText').value.trim();
            if (!text) {
                alert('❌ متن بیانیه را وارد کنید!');
                return;
            }

            try {
                await addNews(`📢 بیانیه رسمی ${currentCountry.name}: ${text}`, currentCountry.name);
                document.getElementById('statementText').value = '';
                alert('✅ بیانیه با موفقیت منتشر شد! جزئیات در اخبار مشاهده کنید.');
            } catch (error) {
                console.error('Error publishing statement:', error);
                alert('❌ خطا در انتشار بیانیه!');
            }
        }

        // بارگذاری بخش تجارت
        async function loadTradeSection() {
            try {
                const countriesSnapshot = await db.collection('countries').get();
                const select = document.getElementById('tradeCountry');
                
                const options = ['<option value="">کشور مقصد را انتخاب کنید...</option>'];
                countriesSnapshot.forEach(doc => {
                    if (doc.id !== currentUser) {
                        const country = doc.data();
                        options.push(`<option value="${doc.id}">${country.name}</option>`);
                    }
                });
                
                select.innerHTML = options.join('');
                loadTradeRequests();
            } catch (error) {
                console.error('Error loading trade section:', error);
            }
        }

        // ارسال درخواست تجارت
        async function sendTradeRequest() {
            if (!checkGameAccess('ارسال درخواست تجارت')) return;
            const targetCountry = document.getElementById('tradeCountry').value;
            const give = document.getElementById('tradeGive').value.trim();
            const receive = document.getElementById('tradeReceive').value.trim();

            if (!targetCountry || !give || !receive) {
                alert('❌ تمام فیلدها را پر کنید!');
                return;
            }

            try {
                const targetDoc = await db.collection('countries').doc(targetCountry).get();
                const targetCountryData = targetDoc.data();
                
                const tradeRequest = {
                    from: currentUser,
                    fromName: currentCountry.name,
                    to: targetCountry,
                    toName: targetCountryData.name,
                    give: give,
                    receive: receive,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    status: 'pending'
                };

                await db.collection('tradeRequests').add(tradeRequest);
                
                await addNews(`🤝 ${currentCountry.name} درخواست تجاری به ${targetCountryData.name} ارسال کرد. پیشنهاد: ${give} در ازای ${receive}`, 'سیستم');
                
                document.getElementById('tradeGive').value = '';
                document.getElementById('tradeReceive').value = '';
                document.getElementById('tradeCountry').value = '';
                
                alert('✅ درخواست تجارت با موفقیت ارسال شد! جزئیات در اخبار مشاهده کنید.');
            } catch (error) {
                console.error('Error sending trade request:', error);
                alert('❌ خطا در ارسال درخواست!');
            }
        }

        // بارگذاری درخواست‌های تجارت
        async function loadTradeRequests() {
            try {
                // بارگذاری درخواست‌های دریافتی
                const tradeRequestsSnapshot = await db.collection('tradeRequests')
                    .where('to', '==', currentUser)
                    .where('status', '==', 'pending')
                    .orderBy('timestamp', 'desc')
                    .get();
                
                const container = document.getElementById('tradeRequests');
                
                const requestsHTML = [];
                tradeRequestsSnapshot.forEach(doc => {
                    const req = doc.data();
                    const date = req.timestamp ? req.timestamp.toDate().toLocaleDateString('fa-IR') + ' ' + req.timestamp.toDate().toLocaleTimeString('fa-IR', {hour: '2-digit', minute: '2-digit'}) : 'نامشخص';
                    requestsHTML.push(`
                        <div class="glass-card p-6 border border-green-500/30 text-white">
                            <div class="flex items-center gap-4 mb-4">
                                <div class="text-4xl">🤝</div>
                                <div>
                                    <p class="font-bold text-green-400 text-lg">${req.fromName}</p>
                                    <p class="text-sm text-slate-400">${date}</p>
                                </div>
                            </div>
                            <div class="space-y-3 mb-6">
                                <p class="flex items-center gap-3 text-white">
                                    <span class="text-yellow-400 text-xl">📤</span>
                                    پیشنهاد آنها: <span class="font-bold">${req.give}</span>
                                </p>
                                <p class="flex items-center gap-3 text-white">
                                    <span class="text-blue-400 text-xl">📥</span>
                                    درخواست آنها: <span class="font-bold">${req.receive}</span>
                                </p>
                            </div>
                            <div class="flex gap-4">
                                <button onclick="acceptTrade('${doc.id}')" class="flex-1 peace-btn">
                                    ✅ قبول معامله
                                </button>
                                <button onclick="rejectTrade('${doc.id}')" class="flex-1 war-btn">
                                    ❌ رد معامله
                                </button>
                            </div>
                        </div>
                    `);
                });
                
                container.innerHTML = requestsHTML.join('') || '<p class="text-slate-400 text-center text-lg">درخواست تجاری جدیدی وجود ندارد</p>';
                
                // نمایش تعداد درخواست‌های جدید در عنوان
                if (requestsHTML.length > 0) {
                    document.title = `(${requestsHTML.length}) جنگ جهانی سوم - درخواست تجاری جدید!`;
                } else {
                    document.title = 'جنگ جهانی سوم - بازی استراتژیک';
                }
                
            } catch (error) {
                console.error('Error loading trade requests:', error);
                const container = document.getElementById('tradeRequests');
                container.innerHTML = '<p class="text-red-400 text-center text-lg">خطا در بارگذاری درخواست‌ها</p>';
            }
        }

        // تایید تجارت
        async function acceptTrade(tradeId) {
            if (!checkGameAccess('پذیرش تجارت')) return;
            try {
                const tradeDoc = await db.collection('tradeRequests').doc(tradeId).get();
                const trade = tradeDoc.data();
                
                if (trade) {
                    await addNews(`✅ ${trade.toName} درخواست تجاری ${trade.fromName} را پذیرفت. معامله انجام شد: ${trade.give} در ازای ${trade.receive}`, 'سیستم');
                    
                    await db.collection('tradeRequests').doc(tradeId).update({
                        status: 'accepted'
                    });
                    
                    loadTradeRequests();
                    alert('✅ درخواست تجاری با موفقیت پذیرفته شد! شرح کامل معامله را در اخبار مشاهده کنید.');
                }
            } catch (error) {
                console.error('Error accepting trade:', error);
                alert('❌ خطا در پذیرش تجارت!');
            }
        }

        // رد تجارت
        async function rejectTrade(tradeId) {
            if (!checkGameAccess('رد تجارت')) return;
            try {
                const tradeDoc = await db.collection('tradeRequests').doc(tradeId).get();
                const trade = tradeDoc.data();
                
                await addNews(`❌ ${trade.toName} درخواست تجاری ${trade.fromName} را رد کرد.`, 'سیستم');
                
                await db.collection('tradeRequests').doc(tradeId).update({
                    status: 'rejected'
                });
                
                loadTradeRequests();
                alert('✅ درخواست تجاری رد شد! جزئیات در اخبار مشاهده کنید.');
            } catch (error) {
                console.error('Error rejecting trade:', error);
                alert('❌ خطا در رد تجارت!');
            }
        }

        // بارگذاری بخش حمله
        async function loadAttackSection() {
            try {
                const countriesSnapshot = await db.collection('countries').get();
                const select = document.getElementById('attackTarget');
                
                const options = ['<option value="">هدف را انتخاب کنید...</option>'];
                countriesSnapshot.forEach(doc => {
                    if (doc.id !== currentUser) {
                        const country = doc.data();
                        options.push(`<option value="${doc.id}">${country.name}</option>`);
                    }
                });
                
                select.innerHTML = options.join('');
                updateAttackForm();
            } catch (error) {
                console.error('Error loading attack section:', error);
            }
        }

        // به‌روزرسانی فرم حمله
        function updateAttackForm() {
            const attackType = document.getElementById('attackType').value;
            
            // مخفی کردن همه فرم‌ها
            document.getElementById('airAttackForm').classList.add('hidden');
            document.getElementById('landAttackForm').classList.add('hidden');
            document.getElementById('seaAttackForm').classList.add('hidden');
            
            if (attackType && currentCountry) {
                // نمایش فرم مربوطه و به‌روزرسانی اعداد موجود
                if (attackType === 'air') {
                    const form = document.getElementById('airAttackForm');
                    form.innerHTML = `
                        <h3 class="text-xl font-bold mb-4 text-red-400">🛩️ تجهیزات مورد نیاز برای حمله هوایی</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div>
                                <label class="block text-sm font-medium text-slate-300 mb-3">جنگنده (موجود: ${currentCountry.fighters || 0})</label>
                                <input type="number" id="airFighters" class="war-input" placeholder="تعداد جنگنده" min="0" max="${currentCountry.fighters || 0}">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-300 mb-3">بمب‌افکن (موجود: ${currentCountry.bombers || 0})</label>
                                <input type="number" id="airBombers" class="war-input" placeholder="تعداد بمب‌افکن" min="0" max="${currentCountry.bombers || 0}">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-300 mb-3">موشک (موجود: ${currentCountry.missiles || 0})</label>
                                <input type="number" id="airMissiles" class="war-input" placeholder="تعداد موشک" min="0" max="${currentCountry.missiles || 0}">
                            </div>
                        </div>
                    `;
                    form.classList.remove('hidden');
                } else if (attackType === 'land') {
                    const form = document.getElementById('landAttackForm');
                    form.innerHTML = `
                        <h3 class="text-xl font-bold mb-4 text-red-400">🚗 تجهیزات مورد نیاز برای حمله زمینی</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div>
                                <label class="block text-sm font-medium text-slate-300 mb-3">تانک (موجود: ${currentCountry.tanks || 0})</label>
                                <input type="number" id="landTanks" class="war-input" placeholder="تعداد تانک" min="0" max="${currentCountry.tanks || 0}">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-300 mb-3">سرباز (موجود: ${(currentCountry.soldiers || 0).toLocaleString()})</label>
                                <input type="number" id="landSoldiers" class="war-input" placeholder="تعداد سرباز" min="0" max="${currentCountry.soldiers || 0}">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-300 mb-3">موشک (موجود: ${currentCountry.missiles || 0})</label>
                                <input type="number" id="landMissiles" class="war-input" placeholder="تعداد موشک" min="0" max="${currentCountry.missiles || 0}">
                            </div>
                        </div>
                    `;
                    form.classList.remove('hidden');
                } else if (attackType === 'sea') {
                    const form = document.getElementById('seaAttackForm');
                    form.innerHTML = `
                        <h3 class="text-xl font-bold mb-4 text-red-400">🚢 تجهیزات مورد نیاز برای حمله دریایی</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div>
                                <label class="block text-sm font-medium text-slate-300 mb-3">ناو جنگی (موجود: ${currentCountry.warships || 0})</label>
                                <input type="number" id="seaWarships" class="war-input" placeholder="تعداد ناو جنگی" min="0" max="${currentCountry.warships || 0}">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-300 mb-3">موشک (موجود: ${currentCountry.missiles || 0})</label>
                                <input type="number" id="seaMissiles" class="war-input" placeholder="تعداد موشک" min="0" max="${currentCountry.missiles || 0}">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-300 mb-3">جنگنده (موجود: ${currentCountry.fighters || 0})</label>
                                <input type="number" id="seaFighters" class="war-input" placeholder="تعداد جنگنده" min="0" max="${currentCountry.fighters || 0}">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-300 mb-3">بمب‌افکن (موجود: ${currentCountry.bombers || 0})</label>
                                <input type="number" id="seaBombers" class="war-input" placeholder="تعداد بمب‌افکن" min="0" max="${currentCountry.bombers || 0}">
                            </div>
                        </div>
                    `;
                    form.classList.remove('hidden');
                }
            }
        }

        // شروع حمله
        async function launchAttack() {
            if (!checkGameAccess('حمله نظامی')) return;
            const target = document.getElementById('attackTarget').value;
            const attackType = document.getElementById('attackType').value;

            if (!target || !attackType) {
                alert('❌ کشور هدف و نوع حمله را انتخاب کنید!');
                return;
            }

            // بررسی تجهیزات مورد نیاز
            let requiredEquipment = {};
            let hasEnoughEquipment = true;
            let errorMessage = '';

            if (attackType === 'air') {
                const fighters = parseInt(document.getElementById('airFighters').value) || 0;
                const bombers = parseInt(document.getElementById('airBombers').value) || 0;
                const missiles = parseInt(document.getElementById('airMissiles').value) || 0;

                if (fighters <= 0 && bombers <= 0 && missiles <= 0) {
                    alert('❌ حداقل یکی از تجهیزات هوایی را وارد کنید!');
                    return;
                }

                if (fighters > (currentCountry.fighters || 0)) {
                    hasEnoughEquipment = false;
                    errorMessage += `شما فقط ${currentCountry.fighters || 0} جنگنده دارید!\n`;
                }
                if (bombers > (currentCountry.bombers || 0)) {
                    hasEnoughEquipment = false;
                    errorMessage += `شما فقط ${currentCountry.bombers || 0} بمب‌افکن دارید!\n`;
                }
                if (missiles > (currentCountry.missiles || 0)) {
                    hasEnoughEquipment = false;
                    errorMessage += `شما فقط ${currentCountry.missiles || 0} موشک دارید!\n`;
                }

                requiredEquipment = { fighters, bombers, missiles };
            } else if (attackType === 'land') {
                const tanks = parseInt(document.getElementById('landTanks').value) || 0;
                const soldiers = parseInt(document.getElementById('landSoldiers').value) || 0;
                const missiles = parseInt(document.getElementById('landMissiles').value) || 0;

                if (tanks <= 0 && soldiers <= 0 && missiles <= 0) {
                    alert('❌ حداقل یکی از تجهیزات زمینی را وارد کنید!');
                    return;
                }

                if (tanks > (currentCountry.tanks || 0)) {
                    hasEnoughEquipment = false;
                    errorMessage += `شما فقط ${currentCountry.tanks || 0} تانک دارید!\n`;
                }
                if (soldiers > (currentCountry.soldiers || 0)) {
                    hasEnoughEquipment = false;
                    errorMessage += `شما فقط ${(currentCountry.soldiers || 0).toLocaleString()} سرباز دارید!\n`;
                }
                if (missiles > (currentCountry.missiles || 0)) {
                    hasEnoughEquipment = false;
                    errorMessage += `شما فقط ${currentCountry.missiles || 0} موشک دارید!\n`;
                }

                requiredEquipment = { tanks, soldiers, missiles };
            } else if (attackType === 'sea') {
                const warships = parseInt(document.getElementById('seaWarships').value) || 0;
                const missiles = parseInt(document.getElementById('seaMissiles').value) || 0;
                const fighters = parseInt(document.getElementById('seaFighters').value) || 0;
                const bombers = parseInt(document.getElementById('seaBombers').value) || 0;

                if (warships <= 0 && missiles <= 0 && fighters <= 0 && bombers <= 0) {
                    alert('❌ حداقل یکی از تجهیزات دریایی را وارد کنید!');
                    return;
                }

                if (warships > (currentCountry.warships || 0)) {
                    hasEnoughEquipment = false;
                    errorMessage += `شما فقط ${currentCountry.warships || 0} ناو جنگی دارید!\n`;
                }
                if (missiles > (currentCountry.missiles || 0)) {
                    hasEnoughEquipment = false;
                    errorMessage += `شما فقط ${currentCountry.missiles || 0} موشک دارید!\n`;
                }
                if (fighters > (currentCountry.fighters || 0)) {
                    hasEnoughEquipment = false;
                    errorMessage += `شما فقط ${currentCountry.fighters || 0} جنگنده دارید!\n`;
                }
                if (bombers > (currentCountry.bombers || 0)) {
                    hasEnoughEquipment = false;
                    errorMessage += `شما فقط ${currentCountry.bombers || 0} بمب‌افکن دارید!\n`;
                }

                requiredEquipment = { warships, missiles, fighters, bombers };
            }

            if (!hasEnoughEquipment) {
                alert('❌ شما تجهیزات موجود ندارید!\n\n' + errorMessage);
                return;
            }

            try {
                const targetDoc = await db.collection('countries').doc(target).get();
                const targetCountry = targetDoc.data();

                // محاسبه قدرت حمله بر اساس تجهیزات استفاده شده
                const attackPower = calculateAttackPowerWithEquipment(requiredEquipment, attackType, currentCountry);
                const defensePower = calculateDefensePower(targetCountry);
                
                const success = attackPower > defensePower;
                
                // محاسبه تلفات واقعی‌تر بر اساس تجهیزات استفاده شده
                const attackerLossPercentage = Math.random() * 0.25 + 0.15; // 15% تا 40% تلفات
                const defenderLossPercentage = Math.random() * 0.35 + 0.25; // 25% تا 60% تلفات

                const attackerUpdates = {};
                const defenderUpdates = {};

                // کم کردن تجهیزات استفاده شده از حمله‌کننده (تلفات حمله‌کننده)
                if (attackType === 'air') {
                    const fighterLoss = Math.floor(requiredEquipment.fighters * attackerLossPercentage);
                    const bomberLoss = Math.floor(requiredEquipment.bombers * attackerLossPercentage);
                    const missileLoss = Math.floor(requiredEquipment.missiles * attackerLossPercentage);
                    
                    attackerUpdates.fighters = Math.max(0, currentCountry.fighters - fighterLoss);
                    attackerUpdates.bombers = Math.max(0, currentCountry.bombers - bomberLoss);
                    attackerUpdates.missiles = Math.max(0, currentCountry.missiles - missileLoss);
                    
                    // محاسبه آسیب بر اساس قدرت پدافند
                    const defenseStrength = (targetCountry.airDefense || 0);
                    let damageMultiplier = 1;
                    
                    // اگر پدافند ضعیف یا نداشت، آسیب بیشتری وارد می‌شود
                    if (defenseStrength < 50) {
                        damageMultiplier = success ? 3.0 : 2.2; // پدافند خیلی ضعیف
                    } else if (defenseStrength < 150) {
                        damageMultiplier = success ? 2.2 : 1.6; // پدافند ضعیف
                    } else if (defenseStrength < 300) {
                        damageMultiplier = success ? 1.6 : 1.2; // پدافند متوسط
                    } else {
                        damageMultiplier = success ? 1.2 : 0.8; // پدافند قوی
                    }
                    
                    // تلفات مدافع - ابتدا پدافند هوایی
                    const airDefenseDestroyed = Math.floor((targetCountry.airDefense || 0) * defenderLossPercentage * damageMultiplier);
                    defenderUpdates.airDefense = Math.max(0, (targetCountry.airDefense || 0) - airDefenseDestroyed);
                    
                    // آسیب به تجهیزات و منابع - اگر پدافند کم باشد، آسیب بیشتری به سایر تجهیزات
                    const moneyDamage = Math.floor(200 * damageMultiplier);
                    const fighterDamage = Math.floor(35 * damageMultiplier);
                    const bomberDamage = Math.floor(25 * damageMultiplier);
                    const missileDamage = Math.floor(40 * damageMultiplier);
                    const tankDamage = Math.floor(20 * damageMultiplier);
                    const soldierDamage = Math.floor(15000 * damageMultiplier);
                    
                    defenderUpdates.money = Math.max(0, (targetCountry.money || 0) - moneyDamage);
                    defenderUpdates.fighters = Math.max(0, (targetCountry.fighters || 0) - fighterDamage);
                    defenderUpdates.bombers = Math.max(0, (targetCountry.bombers || 0) - bomberDamage);
                    defenderUpdates.missiles = Math.max(0, (targetCountry.missiles || 0) - missileDamage);
                    defenderUpdates.tanks = Math.max(0, (targetCountry.tanks || 0) - tankDamage);
                    defenderUpdates.soldiers = Math.max(0, (targetCountry.soldiers || 0) - soldierDamage);
                    
                    currentCountry.fighters = attackerUpdates.fighters;
                    currentCountry.bombers = attackerUpdates.bombers;
                    currentCountry.missiles = attackerUpdates.missiles;
                    
                } else if (attackType === 'land') {
                    const tankLoss = Math.floor(requiredEquipment.tanks * attackerLossPercentage);
                    const soldierLoss = Math.floor(requiredEquipment.soldiers * attackerLossPercentage);
                    const missileLoss = Math.floor(requiredEquipment.missiles * attackerLossPercentage);
                    
                    attackerUpdates.tanks = Math.max(0, currentCountry.tanks - tankLoss);
                    attackerUpdates.soldiers = Math.max(0, currentCountry.soldiers - soldierLoss);
                    attackerUpdates.missiles = Math.max(0, currentCountry.missiles - missileLoss);
                    
                    // تلفات مدافع - ابتدا نیروهای زمینی
                    const soldierDefLoss = Math.floor((targetCountry.soldiers || 0) * defenderLossPercentage);
                    const tankDefLoss = Math.floor((targetCountry.tanks || 0) * defenderLossPercentage);
                    defenderUpdates.soldiers = Math.max(0, (targetCountry.soldiers || 0) - soldierDefLoss);
                    defenderUpdates.tanks = Math.max(0, (targetCountry.tanks || 0) - tankDefLoss);
                    
                    // محاسبه آسیب اضافی بر اساس قدرت دفاع زمینی
                    const defenseStrength = (targetCountry.defense || 0);
                    let additionalDamageMultiplier = 1;
                    
                    if (defenseStrength < 50) {
                        additionalDamageMultiplier = success ? 2.2 : 1.6;
                    } else if (defenseStrength < 70) {
                        additionalDamageMultiplier = success ? 1.6 : 1.2;
                    } else if (defenseStrength < 85) {
                        additionalDamageMultiplier = success ? 1.2 : 0.9;
                    } else {
                        additionalDamageMultiplier = success ? 0.9 : 0.6;
                    }
                    
                    // آسیب به منابع و تجهیزات
                    const moneyDamage = Math.floor(250 * additionalDamageMultiplier);
                    const techDamage = Math.floor(8 * additionalDamageMultiplier);
                    const airDefenseDamage = Math.floor(40 * additionalDamageMultiplier);
                    
                    defenderUpdates.money = Math.max(0, (targetCountry.money || 0) - moneyDamage);
                    defenderUpdates.technology = Math.max(0, (targetCountry.technology || 0) - techDamage);
                    defenderUpdates.airDefense = Math.max(0, (targetCountry.airDefense || 0) - airDefenseDamage);
                    
                    currentCountry.tanks = attackerUpdates.tanks;
                    currentCountry.soldiers = attackerUpdates.soldiers;
                    currentCountry.missiles = attackerUpdates.missiles;
                    
                } else if (attackType === 'sea') {
                    const warshipLoss = Math.floor(requiredEquipment.warships * attackerLossPercentage);
                    const missileLoss = Math.floor(requiredEquipment.missiles * attackerLossPercentage);
                    const fighterLoss = Math.floor(requiredEquipment.fighters * attackerLossPercentage);
                    const bomberLoss = Math.floor(requiredEquipment.bombers * attackerLossPercentage);
                    
                    attackerUpdates.warships = Math.max(0, currentCountry.warships - warshipLoss);
                    attackerUpdates.missiles = Math.max(0, currentCountry.missiles - missileLoss);
                    attackerUpdates.fighters = Math.max(0, currentCountry.fighters - fighterLoss);
                    attackerUpdates.bombers = Math.max(0, currentCountry.bombers - bomberLoss);
                    
                    // محاسبه آسیب بر اساس قدرت دفاع دریایی
                    const navalDefenseStrength = (targetCountry.warships || 0) + (targetCountry.airDefense || 0) * 0.5;
                    let damageMultiplier = 1;
                    
                    // اگر دفاع دریایی ضعیف باشد، آسیب بیشتری وارد می‌شود
                    if (navalDefenseStrength < 50) {
                        damageMultiplier = success ? 3.2 : 2.4;
                    } else if (navalDefenseStrength < 120) {
                        damageMultiplier = success ? 2.4 : 1.8;
                    } else if (navalDefenseStrength < 200) {
                        damageMultiplier = success ? 1.8 : 1.3;
                    } else {
                        damageMultiplier = success ? 1.3 : 0.9;
                    }
                    
                    // تلفات مدافع - ابتدا ناوگان و پدافند
                    const warshipDefLoss = Math.floor((targetCountry.warships || 0) * defenderLossPercentage * damageMultiplier);
                    const airDefenseDestroyed = Math.floor((targetCountry.airDefense || 0) * defenderLossPercentage * damageMultiplier);
                    defenderUpdates.warships = Math.max(0, (targetCountry.warships || 0) - warshipDefLoss);
                    defenderUpdates.airDefense = Math.max(0, (targetCountry.airDefense || 0) - airDefenseDestroyed);
                    
                    // آسیب به منابع و تجهیزات - اگر دفاع دریایی ضعیف باشد، آسیب بیشتری به سایر تجهیزات
                    const moneyDamage = Math.floor(500 * damageMultiplier);
                    const missileDamage = Math.floor(70 * damageMultiplier);
                    const fighterDamage = Math.floor(45 * damageMultiplier);
                    const bomberDamage = Math.floor(30 * damageMultiplier);
                    const tankDamage = Math.floor(25 * damageMultiplier);
                    const soldierDamage = Math.floor(20000 * damageMultiplier);
                    
                    defenderUpdates.money = Math.max(0, (targetCountry.money || 0) - moneyDamage);
                    defenderUpdates.missiles = Math.max(0, (targetCountry.missiles || 0) - missileDamage);
                    defenderUpdates.fighters = Math.max(0, (targetCountry.fighters || 0) - fighterDamage);
                    defenderUpdates.bombers = Math.max(0, (targetCountry.bombers || 0) - bomberDamage);
                    defenderUpdates.tanks = Math.max(0, (targetCountry.tanks || 0) - tankDamage);
                    defenderUpdates.soldiers = Math.max(0, (targetCountry.soldiers || 0) - soldierDamage);
                    
                    currentCountry.warships = attackerUpdates.warships;
                    currentCountry.missiles = attackerUpdates.missiles;
                    currentCountry.fighters = attackerUpdates.fighters;
                    currentCountry.bombers = attackerUpdates.bombers;
                }

                await db.collection('countries').doc(currentUser).update(attackerUpdates);
                await db.collection('countries').doc(target).update(defenderUpdates);

                const attackTypeName = attackType === 'air' ? 'حمله هوایی' : attackType === 'land' ? 'حمله زمینی' : 'حمله دریایی';
                const result = success ? 'موفقیت‌آمیز' : 'ناموفق';
                
                // جزئیات تلفات
                let equipmentUsed = '';
                let lossDetails = '';
                
                if (attackType === 'air') {
                    equipmentUsed = `${requiredEquipment.fighters} جنگنده، ${requiredEquipment.bombers} بمب‌افکن، ${requiredEquipment.missiles} موشک`;
                    lossDetails = `تلفات ${currentCountry.name}: ${Math.floor(requiredEquipment.fighters * attackerLossPercentage)} جنگنده، ${Math.floor(requiredEquipment.bombers * attackerLossPercentage)} بمب‌افکن، ${Math.floor(requiredEquipment.missiles * attackerLossPercentage)} موشک`;
                } else if (attackType === 'land') {
                    equipmentUsed = `${requiredEquipment.tanks} تانک، ${requiredEquipment.soldiers.toLocaleString()} سرباز، ${requiredEquipment.missiles} موشک`;
                    lossDetails = `تلفات ${currentCountry.name}: ${Math.floor(requiredEquipment.tanks * attackerLossPercentage)} تانک، ${Math.floor(requiredEquipment.soldiers * attackerLossPercentage).toLocaleString()} سرباز، ${Math.floor(requiredEquipment.missiles * attackerLossPercentage)} موشک`;
                } else {
                    equipmentUsed = `${requiredEquipment.warships} ناو جنگی، ${requiredEquipment.missiles} موشک، ${requiredEquipment.fighters} جنگنده، ${requiredEquipment.bombers} بمب‌افکن`;
                    lossDetails = `تلفات ${currentCountry.name}: ${Math.floor(requiredEquipment.warships * attackerLossPercentage)} ناو جنگی، ${Math.floor(requiredEquipment.missiles * attackerLossPercentage)} موشک، ${Math.floor(requiredEquipment.fighters * attackerLossPercentage)} جنگنده، ${Math.floor(requiredEquipment.bombers * attackerLossPercentage)} بمب‌افکن`;
                }
                
                await addNews(`⚔️ ${currentCountry.name} با استفاده از ${equipmentUsed} ${attackTypeName} ${result} علیه ${targetCountry.name} انجام داد. ${lossDetails}. ${success ? 'حمله‌کننده پیروز شد و به تجهیزات و منابع دشمن آسیب زد!' : 'مدافع مقاومت کرد!'}`, 'سیستم');

                // پاک کردن فرم‌ها
                document.getElementById('attackTarget').value = '';
                document.getElementById('attackType').value = '';
                updateAttackForm();
                
                loadPlayerStats();
                alert(`${success ? '✅' : '❌'} حمله انجام شد! شرح کامل حمله را در اخبار بخوانید.`);
            } catch (error) {
                console.error('Error launching attack:', error);
                alert('❌ خطا در حمله!');
            }
        }

        // محاسبه قدرت حمله با تجهیزات مشخص
        function calculateAttackPowerWithEquipment(equipment, attackType, country) {
            let power = 0;
            const techBonus = (country.technology / 100) * 500;
            
            if (attackType === 'air') {
                power = (equipment.fighters || 0) * 3 + (equipment.bombers || 0) * 5 + (equipment.missiles || 0) * 2 + techBonus;
            } else if (attackType === 'land') {
                power = (equipment.tanks || 0) * 4 + (equipment.soldiers || 0) * 0.002 + (equipment.missiles || 0) * 2 + techBonus;
            } else if (attackType === 'sea') {
                power = (equipment.warships || 0) * 15 + (equipment.missiles || 0) * 3 + (equipment.fighters || 0) * 2 + (equipment.bombers || 0) * 4 + techBonus;
            }
            
            return power;
        }

        // محاسبه قدرت حمله
        function calculateAttackPower(country, attackType) {
            if (attackType === 'air') {
                return country.fighters * 3 + country.bombers * 5 + (country.technology / 100) * 500;
            } else if (attackType === 'land') {
                return country.tanks * 4 + country.soldiers * 0.002 + (country.technology / 100) * 300;
            } else if (attackType === 'sea') {
                return country.warships * 15 + country.missiles * 3 + (country.technology / 100) * 400;
            }
            return 0;
        }

        // محاسبه قدرت دفاع
        function calculateDefensePower(country) {
            return country.airDefense * 4 + (country.defense / 100) * 2000 + country.soldiers * 0.002 + (country.technology / 100) * 300;
        }

        // اضافه کردن خبر
        async function addNews(content, author) {
            try {
                await db.collection('news').add({
                    content: content,
                    author: author,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
            } catch (error) {
                console.error('Error adding news:', error);
            }
        }

        // بارگذاری اخبار
        async function loadNews() {
            try {
                const newsSnapshot = await db.collection('news').orderBy('timestamp', 'desc').limit(30).get();
                const container = document.getElementById('newsList');
                
                const newsHTML = [];
                newsSnapshot.forEach(doc => {
                    const news = doc.data();
                    const date = news.timestamp ? news.timestamp.toDate().toLocaleDateString('fa-IR') + ' ' + news.timestamp.toDate().toLocaleTimeString('fa-IR') : 'نامشخص';
                    newsHTML.push(`
                        <div class="news-card p-8 text-white">
                            <div class="flex justify-between items-start">
                                <div class="flex-1">
                                    <p class="text-sm text-slate-400 mb-4 font-bold">${date}</p>
                                    <p class="text-white mb-4 text-lg font-semibold">${news.content}</p>
                                    <p class="text-sm text-green-400 font-bold">منبع: ${news.author}</p>
                                </div>
                                ${news.author === currentCountry.name ? `<button onclick="deletePlayerNews('${doc.id}')" class="war-btn">🗑️ حذف</button>` : ''}
                            </div>
                        </div>
                    `);
                });
                
                container.innerHTML = newsHTML.join('') || '<p class="text-slate-400 text-center text-2xl font-bold">خبری موجود نیست</p>';
            } catch (error) {
                console.error('Error loading news:', error);
            }
        }

        // حذف خبر توسط بازیکن
        async function deletePlayerNews(newsId) {
            try {
                const newsDoc = await db.collection('news').doc(newsId).get();
                const news = newsDoc.data();
                
                if (news && news.author === currentCountry.name) {
                    await db.collection('news').doc(newsId).delete();
                    loadNews();
                    alert('✅ خبر با موفقیت حذف شد!');
                } else {
                    alert('❌ فقط می‌توانید اخبار خود را حذف کنید!');
                }
            } catch (error) {
                console.error('Error deleting player news:', error);
                alert('❌ خطا در حذف خبر!');
            }
        }

        // بارگذاری بخش کنترل بازی
        async function loadGameControlSection() {
            await checkGameStatus();
            updateGameStatusDisplay();
        }

        // بررسی وضعیت بازی
        async function checkGameStatus() {
            try {
                const gameStatusDoc = await db.collection('gameSettings').doc('status').get();
                if (gameStatusDoc.exists) {
                    gameEnabled = gameStatusDoc.data().enabled;
                } else {
                    // اگر سند وجود نداشت، بازی را روشن در نظر بگیریم
                    gameEnabled = true;
                    await db.collection('gameSettings').doc('status').set({ enabled: true });
                }
                updatePlayerMenuAccess();
            } catch (error) {
                console.error('Error checking game status:', error);
                gameEnabled = true; // در صورت خطا، بازی را روشن در نظر بگیریم
            }
        }

        // تغییر وضعیت بازی
        async function toggleGameStatus(enable) {
            try {
                await db.collection('gameSettings').doc('status').set({ enabled: enable });
                gameEnabled = enable;
                
                const statusText = enable ? 'روشن' : 'خاموش';
                await addNews(`🎮 ادمین بازی را ${statusText} کرد. ${enable ? 'بازیکنان اکنون دسترسی کامل به امکانات دارند.' : 'بازیکنان فقط می‌توانند آمار خود را مشاهده کنند.'}`, 'سیستم');
                
                updateGameStatusDisplay();
                alert(`✅ بازی با موفقیت ${statusText} شد! جزئیات در اخبار مشاهده کنید.`);
            } catch (error) {
                console.error('Error toggling game status:', error);
                alert('❌ خطا در تغییر وضعیت بازی!');
            }
        }

        // به‌روزرسانی نمایش وضعیت بازی
        function updateGameStatusDisplay() {
            const icon = document.getElementById('gameStatusIcon');
            const text = document.getElementById('gameStatusText');
            const desc = document.getElementById('gameStatusDesc');
            
            if (gameEnabled) {
                icon.textContent = '🟢';
                text.textContent = 'بازی روشن است';
                desc.textContent = 'بازیکنان دسترسی کامل به امکانات دارند';
            } else {
                icon.textContent = '🔴';
                text.textContent = 'بازی خاموش است';
                desc.textContent = 'بازیکنان فقط می‌توانند آمار خود را مشاهده کنند';
            }
        }

        // به‌روزرسانی دسترسی منوی بازیکن
        function updatePlayerMenuAccess() {
            const restrictedSections = ['blackmarket', 'statement', 'trade', 'attack'];
            
            restrictedSections.forEach(section => {
                const menuItems = document.querySelectorAll(`#playerSidebar .sidebar-item[data-section="${section}"], #playerMobileMenu .sidebar-item[data-section="${section}"]`);
                menuItems.forEach(item => {
                    if (gameEnabled) {
                        item.classList.remove('disabled');
                        item.onclick = () => {
                            showPlayerSection(section);
                            closeMobileMenu();
                        };
                    } else {
                        item.classList.add('disabled');
                        item.onclick = () => {
                            alert('🔴 بازی در حال حاضر خاموش است! فقط می‌توانید آمار کشور خود را مشاهده کنید.');
                        };
                    }
                });
            });
        }

        // بررسی دسترسی قبل از انجام عملیات
        function checkGameAccess(actionName) {
            if (!gameEnabled) {
                alert(`🔴 بازی در حال حاضر خاموش است! امکان ${actionName} وجود ندارد.`);
                return false;
            }
            return true;
        }

        // شروع با اتصال به Firebase
        document.addEventListener('DOMContentLoaded', function() {
            initializeFirebase();
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9696d638c0789dc6',t:'MTc1NDIzNDgyMy4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
